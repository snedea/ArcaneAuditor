name: üöÄ Release (Build + Sign + Notarize)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

permissions:
  contents: write

jobs:

  # ü™ü WINDOWS BUILD -----------------------------------------------------------
  windows-build:
    name: üèóÔ∏è Windows Build
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v6
        with:
          version: "0.9.6"

      - name: üèóÔ∏è Build Windows executables
        shell: pwsh
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "üèóÔ∏è  WINDOWS BUILD START" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "üìÖ Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')"
          Write-Host ""
          
          pwsh ./scripts/build.ps1
          
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "‚úÖ BUILD COMPLETE - Listing outputs:" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Green
          if (Test-Path dist) {
            Get-ChildItem dist -Recurse | ForEach-Object {
              $size = if ($_.PSIsContainer) { "DIR" } else { "$([math]::Round($_.Length/1MB, 2)) MB" }
              Write-Host "  üìÑ $($_.FullName) [$size]"
            }
          } else {
            Write-Error "‚ùå CRITICAL: dist/ folder not found after build!"
            exit 1
          }

      - name: üì¶ Upload unsigned Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: unsigned-windows
          path: dist/*.exe


  # üîè WINDOWS EV SIGN --------------------------------------------------------
  windows-sign:
    name: üîè Windows EV Signing
    runs-on: self-hosted
    needs: windows-build

    steps:
      - name: üì• Download unsigned executables
        uses: actions/download-artifact@v4
        with:
          name: unsigned-windows
          path: ./unsigned

      - name: üîç Verify downloads
        shell: pwsh
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "üîç DOWNLOAD VERIFICATION" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "üìÇ Downloaded unsigned files:"
          Get-ChildItem -Recurse ./unsigned | ForEach-Object {
            $size = if ($_.PSIsContainer) { "DIR" } else { "$([math]::Round($_.Length/1MB, 2)) MB" }
            Write-Host "  üìÑ $($_.FullName) [$size]"
          }
          
          if (-not (Test-Path ./unsigned/*.exe)) {
            Write-Host ""
            Write-Host "‚ùå‚ùå‚ùå CRITICAL ERROR ‚ùå‚ùå‚ùå" -ForegroundColor Red
            Write-Host "No executables found in ./unsigned" -ForegroundColor Red
            Write-Host "Expected to find: *.exe files" -ForegroundColor Red
            exit 1
          }
          Write-Host "‚úÖ Download verification passed" -ForegroundColor Green

      - name: üîè Sign executables (local EV cert)
        shell: pwsh
        run: |
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "üîè WINDOWS CODE SIGNING" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          
          $ErrorActionPreference = "Stop"
          $thumb = "A5EBA89B65F776DB3DEB350BD3681BFF52AFE2E8"
          $exeFiles = Get-ChildItem ./unsigned -Filter *.exe

          Write-Host "üîç Found $($exeFiles.Count) executable(s) to sign"
          Write-Host ""

          if ($exeFiles.Count -eq 0) {
            Write-Host "‚ùå‚ùå‚ùå CRITICAL ERROR ‚ùå‚ùå‚ùå" -ForegroundColor Red
            Write-Host "No executables to sign" -ForegroundColor Red
            exit 1
          }

          $signedCount = 0
          foreach ($f in $exeFiles) {
            Write-Host "----------------------------------------"
            Write-Host "üîè Signing: $($f.Name)" -ForegroundColor Yellow
            Write-Host "   Path: $($f.FullName)"
            Write-Host "   Size: $([math]::Round($f.Length/1MB, 2)) MB"
            Write-Host "   Thumbprint: $thumb"
            
            try {
              & signtool.exe sign `
                /sha1 $thumb `
                /fd sha256 /td sha256 `
                /tr http://timestamp.digicert.com `
                $f.FullName
              
              if ($LASTEXITCODE -ne 0) {
                throw "signtool.exe returned exit code $LASTEXITCODE"
              }
              
              Write-Host "‚úÖ Successfully signed: $($f.Name)" -ForegroundColor Green
              $signedCount++
            }
            catch {
              Write-Host "‚ùå‚ùå‚ùå SIGNING FAILED ‚ùå‚ùå‚ùå" -ForegroundColor Red
              Write-Host "File: $($f.Name)" -ForegroundColor Red
              Write-Host "Error: $_" -ForegroundColor Red
              throw
            }
          }

          Write-Host ""
          Write-Host "========================================" -ForegroundColor Cyan
          Write-Host "üîç SIGNATURE VERIFICATION" -ForegroundColor Cyan
          Write-Host "========================================" -ForegroundColor Cyan
          
          $verifiedCount = 0
          foreach ($f in $exeFiles) {
            Write-Host "üîç Verifying: $($f.Name)"
            
            try {
              & signtool.exe verify /pa $f.FullName
              
              if ($LASTEXITCODE -ne 0) {
                throw "Verification failed with exit code $LASTEXITCODE"
              }
              
              Write-Host "‚úÖ Verified: $($f.Name)" -ForegroundColor Green
              $verifiedCount++
            }
            catch {
              Write-Host "‚ùå‚ùå‚ùå VERIFICATION FAILED ‚ùå‚ùå‚ùå" -ForegroundColor Red
              Write-Host "File: $($f.Name)" -ForegroundColor Red
              Write-Host "Error: $_" -ForegroundColor Red
              throw
            }
          }

          Write-Host ""
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "‚úÖ WINDOWS SIGNING COMPLETE" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "üìä Summary:"
          Write-Host "   Total files: $($exeFiles.Count)"
          Write-Host "   Signed: $signedCount"
          Write-Host "   Verified: $verifiedCount"

      - name: üì§ Upload signed Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: signed-windows
          path: ./unsigned/*.exe


  # üçé MAC BUILD + SIGN + NOTARIZE --------------------------------------------
  mac-build-sign:
    name: üçé macOS Build + Sign + Notarize
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v6
        with:
          version: "0.9.6"

      - name: üèóÔ∏è Build macOS executables
        run: |
          echo "========================================"
          echo "üèóÔ∏è  macOS BUILD START"
          echo "========================================"
          echo "üìÖ Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          
          bash ./scripts/build.sh
          
          echo ""
          echo "========================================"
          echo "‚úÖ BUILD COMPLETE - Listing outputs:"
          echo "========================================"
          if [ -d dist ]; then
            find dist -type f -o -type d | while read item; do
              if [ -f "$item" ]; then
                size=$(du -h "$item" | cut -f1)
                echo "  üìÑ $item [$size]"
              else
                echo "  üìÅ $item/"
              fi
            done
          else
            echo "‚ùå‚ùå‚ùå CRITICAL: dist/ folder not found after build!"
            exit 1
          fi
          
          echo ""
          echo "üîß Setting executable permissions on CLI binary..."
          if [ -f "dist/ArcaneAuditorCLI" ]; then
            chmod +x dist/ArcaneAuditorCLI
            echo "‚úÖ CLI binary is now executable"
            ls -l dist/ArcaneAuditorCLI
          else
            echo "‚ö†Ô∏è  CLI binary not found (may be expected)"
          fi

      - name: üîè Import Developer ID certificate
        env:
          MAC_CERT: ${{ secrets.MACOS_CERTIFICATE }}
          MAC_CERT_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
        run: |
          echo "========================================"
          echo "üîè KEYCHAIN SETUP"
          echo "========================================"
          echo "üìÖ Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
          
          echo "üîë Decoding certificate..."
          echo "$MAC_CERT" | base64 --decode > cert.p12
          
          echo "üîê Creating build keychain..."
          security create-keychain -p password build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p password build.keychain
          
          echo "üì• Importing certificate..."
          security import cert.p12 -k build.keychain -P "$MAC_CERT_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k password build.keychain
          
          rm cert.p12
          echo "‚úÖ Certificate imported successfully"
          
          echo ""
          echo "üîç Available signing identities:"
          security find-identity -v -p codesigning
          echo ""

      - name: üîç Pre-signing verification
        run: |
          echo "========================================"
          echo "üîç PRE-SIGNING VERIFICATION"
          echo "========================================"
          
          APP="dist/ArcaneAuditor.app"
          CLI="dist/ArcaneAuditorCLI"
          
          if [ ! -d "$APP" ]; then
            echo "‚ùå‚ùå‚ùå CRITICAL: $APP not found!"
            echo "Contents of dist/:"
            ls -la dist/ || echo "dist/ doesn't exist"
            exit 1
          fi
          
          echo "‚úÖ Found: $APP"
          echo "   Size: $(du -sh "$APP" | cut -f1)"
          
          if [ -f "$CLI" ]; then
            echo "‚úÖ Found: $CLI"
            echo "   Size: $(du -h "$CLI" | cut -f1)"
          else
            echo "‚ö†Ô∏è  WARNING: CLI binary not found at $CLI"
            echo "   This may be expected if CLI wasn't built"
          fi
          
          echo ""
          echo "üì¶ .app bundle structure:"
          find "$APP" -maxdepth 3 -type f -o -type d | head -20

      - name: üîè Sign .app bundle (comprehensive signing)
        env:
          MAC_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          set -e
          echo "========================================"
          echo "üîè SIGNING .APP BUNDLE"
          echo "========================================"
          echo "üìÖ Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "üîë Identity: $MAC_IDENTITY"
          echo ""
          
          APP="dist/ArcaneAuditor.app"
          
          # Step 1: Sign ALL embedded libraries (.dylib, .so) FIRST
          echo "----------------------------------------"
          echo "Step 1: Signing ALL embedded libraries"
          echo "----------------------------------------"
          echo "üîç Finding all dylibs and shared libraries..."
          
          SIGNED_COUNT=0
          # Find and sign all .dylib and .so files recursively
          find "$APP/Contents" -type f \( -name "*.dylib" -o -name "*.so" \) | while read lib; do
            echo "üîè Signing library: $(basename "$lib")"
            codesign --force --options runtime --timestamp --sign "$MAC_IDENTITY" "$lib" 2>&1
            if [ $? -eq 0 ]; then
              echo "   ‚úÖ Signed: $lib"
            else
              echo "   ‚ùå FAILED to sign: $lib"
              exit 1
            fi
          done
          
          # Also sign any Mach-O executables in Frameworks
          if [ -d "$APP/Contents/Frameworks" ]; then
            find "$APP/Contents/Frameworks" -type f -perm +111 | while read f; do
              if file "$f" | grep -q "Mach-O"; then
                echo "üîè Signing framework binary: $(basename "$f")"
                codesign --force --options runtime --timestamp --sign "$MAC_IDENTITY" "$f" 2>&1
                if [ $? -eq 0 ]; then
                  echo "   ‚úÖ Signed: $f"
                else
                  echo "   ‚ùå FAILED to sign: $f"
                  exit 1
                fi
              fi
            done
          fi
          
          echo "‚úÖ All embedded libraries signed"
          
          echo ""
          echo "----------------------------------------"
          echo "Step 2: Signing Python runtime files"
          echo "----------------------------------------"
          
          # Sign any Python*.framework if present
          if [ -d "$APP/Contents/Frameworks/Python.framework" ]; then
            echo "üîè Signing Python.framework..."
            find "$APP/Contents/Frameworks/Python.framework" -type f -name "Python" | while read py; do
              codesign --force --options runtime --timestamp --sign "$MAC_IDENTITY" "$py" 2>&1
              echo "   ‚úÖ Signed: $py"
            done
          fi
          
          echo ""
          echo "----------------------------------------"
          echo "Step 3: Signing main executable"
          echo "----------------------------------------"
          
          MAIN_EXEC="$APP/Contents/MacOS/ArcaneAuditor"
          if [ -f "$MAIN_EXEC" ]; then
            echo "üîè Signing: $MAIN_EXEC"
            codesign --force --options runtime --timestamp --sign "$MAC_IDENTITY" "$MAIN_EXEC" 2>&1
            if [ $? -eq 0 ]; then
              echo "‚úÖ Main executable signed"
            else
              echo "‚ùå‚ùå‚ùå FAILED TO SIGN MAIN EXECUTABLE"
              exit 1
            fi
          else
            echo "‚ùå‚ùå‚ùå CRITICAL: Main executable not found at $MAIN_EXEC"
            exit 1
          fi
          
          echo ""
          echo "----------------------------------------"
          echo "Step 4: Signing entire .app bundle"
          echo "----------------------------------------"
          
          echo "üîè Signing bundle: $APP"
          codesign --force --options runtime --timestamp --sign "$MAC_IDENTITY" "$APP" 2>&1
          if [ $? -eq 0 ]; then
            echo "‚úÖ Bundle signed successfully"
          else
            echo "‚ùå‚ùå‚ùå FAILED TO SIGN BUNDLE"
            exit 1
          fi
          
          echo ""
          echo "----------------------------------------"
          echo "Step 5: Verifying signatures"
          echo "----------------------------------------"
          
          echo "üîç Verifying bundle signature..."
          codesign --verify --deep --strict --verbose=2 "$APP" 2>&1
          if [ $? -eq 0 ]; then
            echo "‚úÖ Signature verification passed"
          else
            echo "‚ö†Ô∏è  Signature verification warning (checking details...)"
            codesign --verify --verbose=4 "$APP" 2>&1
          fi
          
          echo ""
          echo "üîç Checking for Team ID consistency..."
          codesign -dv "$APP" 2>&1 | grep "TeamIdentifier"
          
          echo ""
          echo "üîç Gatekeeper assessment..."
          spctl -a -t exec -vvv "$APP" 2>&1 || echo "‚ö†Ô∏è  Gatekeeper check failed (expected until notarized)"
          
          echo ""
          echo "========================================"
          echo "‚úÖ .APP BUNDLE SIGNING COMPLETE"
          echo "========================================"

      - name: üîè Sign CLI binary
        env:
          MAC_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          set -e
          echo "========================================"
          echo "üîè SIGNING CLI BINARY"
          echo "========================================"
          echo "üìÖ Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
          
          CLI="dist/ArcaneAuditorCLI"
          
          if [ -f "$CLI" ]; then
            echo "üìÑ Found CLI binary: $CLI"
            echo "   Size: $(du -h "$CLI" | cut -f1)"
            echo "   Type: $(file "$CLI")"
            
            echo ""
            echo "üîß Ensuring CLI is executable..."
            chmod +x "$CLI"
            ls -l "$CLI"
            echo ""
            
            echo "üîè Signing CLI binary..."
            codesign --force --options runtime --timestamp --sign "$MAC_IDENTITY" "$CLI" 2>&1
            if [ $? -eq 0 ]; then
              echo "‚úÖ CLI binary signed successfully"
            else
              echo "‚ùå‚ùå‚ùå FAILED TO SIGN CLI BINARY"
              exit 1
            fi
            
            echo ""
            echo "üîç Verifying CLI signature..."
            codesign --verify --verbose=2 "$CLI" 2>&1
            if [ $? -eq 0 ]; then
              echo "‚úÖ CLI signature verified"
            else
              echo "‚ùå‚ùå‚ùå CLI SIGNATURE VERIFICATION FAILED"
              exit 1
            fi
            
            echo ""
            echo "üîç Checking Team ID..."
            codesign -dv "$CLI" 2>&1 | grep "TeamIdentifier"
          else
            echo "‚ö†Ô∏è  CLI binary not found at $CLI"
            echo "   Skipping CLI signing (may be expected)"
          fi
          
          echo ""
          echo "========================================"
          echo "‚úÖ CLI SIGNING COMPLETE (or skipped)"
          echo "========================================"

      - name: üçè Notarize & Staple .app
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        run: |
          echo "========================================"
          echo "üçè NOTARIZING .APP BUNDLE"
          echo "========================================"
          echo "üìÖ Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "üéØ Target: dist/ArcaneAuditor.app"
          echo ""
          
          ./scripts/notarize.sh dist/ArcaneAuditor.app
          
          if [ $? -eq 0 ]; then
            echo ""
            echo "========================================"
            echo "‚úÖ .APP NOTARIZATION COMPLETE"
            echo "========================================"
          else
            echo ""
            echo "‚ùå‚ùå‚ùå NOTARIZATION FAILED ‚ùå‚ùå‚ùå"
            echo "Check notarization logs for details"
            exit 1
          fi

      - name: üçè Sign CLI bundle (all dylibs + executable)
        env:
          MAC_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          echo "========================================"
          echo "üîè SIGNING CLI BUNDLE"
          echo "========================================"
          echo "üìÖ Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          
          CLI_DIR="dist/ArcaneAuditorCLI"
          CLI_BINARY="$CLI_DIR/ArcaneAuditorCLI"
          
          if [ ! -d "$CLI_DIR" ]; then
            echo "‚ö†Ô∏è  CLI directory not found at $CLI_DIR"
            echo "   Skipping CLI signing"
          else
            echo "üìÇ CLI bundle found: $CLI_DIR"
            echo "üîë Signing identity: $MAC_IDENTITY"
            echo ""
            
            # Sign all dylibs first (most important for Team ID consistency)
            echo "üîè Signing all .dylib files..."
            find "$CLI_DIR" -name "*.dylib" -type f | while read dylib; do
              echo "   ‚Üí $(basename "$dylib")"
              codesign --force --options runtime --timestamp --sign "$MAC_IDENTITY" "$dylib" 2>&1 || {
                echo "‚ö†Ô∏è  Failed to sign $(basename "$dylib"), continuing..."
              }
            done
            
            # Sign .so files
            echo ""
            echo "üîè Signing all .so files..."
            find "$CLI_DIR" -name "*.so" -type f | while read so; do
              echo "   ‚Üí $(basename "$so")"
              codesign --force --options runtime --timestamp --sign "$MAC_IDENTITY" "$so" 2>&1 || {
                echo "‚ö†Ô∏è  Failed to sign $(basename "$so"), continuing..."
              }
            done
            
            # Sign any frameworks
            echo ""
            echo "üîè Signing framework bundles..."
            find "$CLI_DIR" -name "*.framework" -type d | while read framework; do
              echo "   ‚Üí $(basename "$framework")"
              codesign --force --options runtime --timestamp --sign "$MAC_IDENTITY" "$framework" 2>&1 || {
                echo "‚ö†Ô∏è  Failed to sign $(basename "$framework"), continuing..."
              }
            done
            
            # Finally, sign the main executable
            echo ""
            echo "üîè Signing main executable..."
            chmod +x "$CLI_BINARY"
            codesign --force --options runtime --timestamp --sign "$MAC_IDENTITY" "$CLI_BINARY" 2>&1
            
            if [ $? -eq 0 ]; then
              echo "‚úÖ Main executable signed successfully"
            else
              echo "‚ùå‚ùå‚ùå FAILED TO SIGN MAIN EXECUTABLE"
              exit 1
            fi
            
            # Verify
            echo ""
            echo "üîç Verifying main executable signature..."
            codesign --verify --verbose=2 "$CLI_BINARY" 2>&1
            if [ $? -eq 0 ]; then
              echo "‚úÖ CLI signature verified"
              
              # Check Team ID
              echo ""
              echo "üîç Checking Team ID..."
              TEAM_ID=$(codesign -dvv "$CLI_BINARY" 2>&1 | grep "TeamIdentifier" | cut -d= -f2)
              echo "   Team ID: $TEAM_ID"
              
              # Check a sample dylib
              SAMPLE_DYLIB=$(find "$CLI_DIR" -name "libpython*.dylib" | head -n 1)
              if [ -n "$SAMPLE_DYLIB" ]; then
                DYLIB_TEAM=$(codesign -dvv "$SAMPLE_DYLIB" 2>&1 | grep "TeamIdentifier" | cut -d= -f2)
                echo "   Sample dylib Team ID: $DYLIB_TEAM"
                
                if [ "$TEAM_ID" = "$DYLIB_TEAM" ]; then
                  echo "‚úÖ Team IDs match!"
                else
                  echo "‚ö†Ô∏è  WARNING: Team ID mismatch detected"
                fi
              fi
            else
              echo "‚ùå‚ùå‚ùå CLI SIGNATURE VERIFICATION FAILED"
              exit 1
            fi
            
            echo ""
            echo "========================================"
            echo "‚úÖ CLI BUNDLE SIGNING COMPLETE"
            echo "========================================"
          fi

      - name: üçè Notarize CLI (zipped bundle)
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        run: |
          CLI_DIR="dist/ArcaneAuditorCLI"
          CLI_BINARY="$CLI_DIR/ArcaneAuditorCLI"
          
          if [ -d "$CLI_DIR" ]; then
            echo "========================================"
            echo "üçè NOTARIZING CLI BUNDLE"
            echo "========================================"
            echo "üìÖ Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
            echo "üéØ Target: $CLI_DIR"
            echo ""
            
            # Create a zip of the entire CLI bundle for notarization
            echo "üì¶ Creating zip archive..."
            ditto -c -k --keepParent "$CLI_DIR" "ArcaneAuditorCLI.zip"
            
            ZIP_SIZE=$(du -h "ArcaneAuditorCLI.zip" | cut -f1)
            echo "‚úÖ Created ArcaneAuditorCLI.zip [$ZIP_SIZE]"
            echo ""
            
            # Submit for notarization
            echo "üì§ Submitting to Apple notary service..."
            xcrun notarytool submit "ArcaneAuditorCLI.zip" \
              --apple-id "$APPLE_ID" \
              --team-id "$APPLE_TEAM_ID" \
              --password "$APPLE_APP_SPECIFIC_PASSWORD" \
              --wait \
              --timeout 30m \
              2>&1
            
            if [ $? -eq 0 ]; then
              echo ""
              echo "‚úÖ CLI notarization successful!"
              echo ""
              echo "========================================"
              echo "‚úÖ CLI NOTARIZATION COMPLETE"
              echo "========================================"
            else
              echo ""
              echo "‚ùå‚ùå‚ùå CLI NOTARIZATION FAILED ‚ùå‚ùå‚ùå"
              exit 1
            fi
          else
            echo "‚ö†Ô∏è  CLI bundle not found, skipping notarization"
          fi

      - name: üì¶ Create & Sign DMG (from notarized .app)
        env:
          MAC_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          set -e
          echo "üì¶ Creating clean, signed DMG..."
          DMG_PATH="dist/ArcaneAuditor_macOS_Desktop.dmg"
          APP_PATH="dist/ArcaneAuditor.app"
          ICON_PATH="assets/icons/aa-mac.icns"

          # 1Ô∏è‚É£ Create a temporary staging folder
          mkdir -p dmg
          cp -R "$APP_PATH" dmg/
          ln -s /Applications dmg/Applications

          # 2Ô∏è‚É£ Add a custom volume icon (survives signing)
          if [ -f "$ICON_PATH" ]; then
            echo "üé® Adding volume icon..."
            cp "$ICON_PATH" dmg/.VolumeIcon.icns
          fi

          # 3Ô∏è‚É£ Build a compressed DMG (UDZO = zlib-compressed read-only)
          hdiutil create -volname "Arcane Auditor" \
            -srcfolder dmg \
            -ov -format UDZO "$DMG_PATH"

          # 4Ô∏è‚É£ Clean up staging folder
          rm -rf dmg

          # 5Ô∏è‚É£ Sign the DMG (not the background; this one‚Äôs layoutless)
          echo "üîè Signing DMG..."
          codesign --force --timestamp --sign "$MAC_IDENTITY" "$DMG_PATH"

          # 6Ô∏è‚É£ Verify signature
          echo "üîç Verifying DMG signature..."
          codesign --verify --verbose=2 "$DMG_PATH"

          # 7Ô∏è‚É£ Show final size
          echo "‚úÖ DMG ready: $(du -h "$DMG_PATH" | cut -f1)"


      - name: üçè Notarize DMG
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        run: |
          echo "========================================"
          echo "üçè NOTARIZING DMG"
          echo "========================================"
          echo "üìÖ Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
          echo "üéØ Target: dist/ArcaneAuditor_macOS_Desktop.dmg"
          echo ""
          
          ./scripts/notarize.sh dist/ArcaneAuditor_macOS_Desktop.dmg
          
          if [ $? -eq 0 ]; then
            echo ""
            echo "========================================"
            echo "‚úÖ DMG NOTARIZATION COMPLETE"
            echo "========================================"
          else
            echo ""
            echo "‚ùå‚ùå‚ùå DMG NOTARIZATION FAILED ‚ùå‚ùå‚ùå"
            echo "Check notarization logs for details"
            exit 1
          fi

      - name: üéØ Final verification
        run: |
          echo "========================================"
          echo "üéØ FINAL VERIFICATION"
          echo "========================================"
          echo "üìÖ Timestamp: $(date '+%Y-%m-%d %H:%M:%S')"
          echo ""
          
          APP="dist/ArcaneAuditor.app"
          CLI_DIR="dist/ArcaneAuditorCLI"
          CLI_BINARY="$CLI_DIR/ArcaneAuditorCLI"
          DMG="dist/ArcaneAuditor_macOS_Desktop.dmg"
          
          echo "üîç Checking .app bundle..."
          if stapler validate "$APP" 2>&1 | grep -q "The validate action worked"; then
            echo "‚úÖ .app is properly notarized and stapled"
          else
            echo "‚ùå .app validation failed"
          fi
          
          if [ -d "$CLI_DIR" ] && [ -f "$CLI_BINARY" ]; then
            echo ""
            echo "üîç Checking CLI bundle..."
            if codesign --verify --verbose=2 "$CLI_BINARY" 2>&1; then
              echo "‚úÖ CLI is properly signed"
              
              # Check notarization status
              if spctl --assess --type execute --verbose=2 "$CLI_BINARY" 2>&1 | grep -q "accepted"; then
                echo "‚úÖ CLI is notarized and will run without Gatekeeper warnings"
              else
                echo "‚ö†Ô∏è  CLI may trigger Gatekeeper warnings (check notarization)"
              fi
            else
              echo "‚ùå CLI signature invalid"
            fi
          elif [ -f "dist/ArcaneAuditorCLI" ]; then
            echo ""
            echo "üîç Checking CLI (single-file mode)..."
            if codesign --verify --verbose=2 "dist/ArcaneAuditorCLI" 2>&1; then
              echo "‚úÖ CLI is properly signed"
            else
              echo "‚ùå CLI signature invalid"
            fi
          else
            echo ""
            echo "‚ö†Ô∏è  CLI not found (neither bundle nor single file)"
          fi
          
          echo ""
          echo "üîç Checking DMG..."
          if stapler validate "$DMG" 2>&1 | grep -q "The validate action worked"; then
            echo "‚úÖ DMG is properly notarized and stapled"
          else
            echo "‚ùå DMG validation failed"
          fi
          
          echo ""
          echo "========================================"
          echo "üìä FINAL BUILD ARTIFACTS"
          echo "========================================"
          ls -lh dist/ || echo "No dist/ folder found"
          
          if [ -d "dist/ArcaneAuditorCLI" ]; then
            echo ""
            echo "üì¶ CLI Bundle contents:"
            ls -lh dist/ArcaneAuditorCLI/ | head -n 15
          fi
          
          echo ""
          echo "========================================"
          echo "üéâ macOS BUILD PIPELINE COMPLETE"
          echo "========================================"

      - name: üì¶ Create CLI distribution zip
        run: |
          echo "========================================"
          echo "üì¶ CREATING CLI DISTRIBUTION ZIP"
          echo "========================================"
          
          CLI_DIR="dist/ArcaneAuditorCLI"
          
          if [ -d "$CLI_DIR" ]; then
            echo "Creating ArcaneAuditor_macOS_CLI.zip for distribution..."
            cd dist
            zip -r ArcaneAuditor_macOS_CLI.zip ArcaneAuditorCLI/
            cd ..
            
            ZIP_SIZE=$(du -h "dist/ArcaneAuditor_macOS_CLI.zip" | cut -f1)
            echo "‚úÖ Created distributable CLI zip [$ZIP_SIZE]"
          else
            echo "‚ö†Ô∏è  CLI bundle not found, skipping zip creation"
          fi

      - name: üì¶ Upload signed macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: signed-macos
          path: |
            dist/*.dmg
            dist/ArcaneAuditor.app
            dist/ArcaneAuditor_macOS_CLI.zip

      - name: üìé Upload notarization logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: notarization-logs
          path: ./notary-logs/
          retention-days: 7


  # üöÄ PUBLISH RELEASE ---------------------------------------------------------
  publish:
    name: üöÄ Publish GitHub Release
    runs-on: ubuntu-latest
    needs: [windows-sign, mac-build-sign]

    steps:
      - uses: actions/checkout@v4
      
      - name: üì• Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-files

      - name: üóÉÔ∏è List release artifacts
        run: |
          echo "========================================"
          echo "üì¶ RELEASE ARTIFACTS"
          echo "========================================"
          find release-files -type f | while read f; do
            size=$(du -h "$f" | cut -f1)
            echo "  üìÑ $f [$size]"
          done
          echo ""
          echo "========================================"

      - name: üöÄ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-files/signed-windows/*.exe
            release-files/signed-macos/*.dmg
            release-files/signed-macos/ArcaneAuditor_macOS_CLI.zip
          draft: true
          prerelease: false
          body: |
            ## üéâ Release ${{ github.ref_name }}
            
            Fully signed and notarized release built from tag `${{ github.ref_name }}`.
            
            ### üì¶ Downloads
            
            **Windows:**
            - `ArcaneAuditor.exe` - Desktop application (EV signed)
            - `ArcaneAuditorCLI.exe` - Command-line tool (EV signed)
            
            **macOS:**
            - `ArcaneAuditor_macOS_Desktop.dmg` - Desktop application installer (signed & notarized)
            - `ArcaneAuditor_macOS_CLI.zip` - Command-line tool bundle (signed & notarized)
            
            **Using the CLI (macOS):**
            1. Download and extract `ArcaneAuditor_macOS_CLI.zip`
            2. Run from the extracted folder: `./ArcaneAuditorCLI/ArcaneAuditorCLI --help`
            3. Optionally, add to PATH or create a symlink
            
            ### ‚úÖ Verification
            
            All binaries have been:
            - ‚úÖ Code signed with valid certificates
            - ‚úÖ Timestamped for long-term validity
            - ‚úÖ Notarized by Apple (macOS)
            - ‚úÖ Verified before release
            
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}